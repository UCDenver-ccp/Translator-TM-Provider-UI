<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
    <title>{{ title }}</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
</head>
<body>
	<main role="main" class="container-fluid">
		<div class="card">
			<div class="card-header">
				Assertion Evidence <a href="/assertions/{{ evidence.assertion_id }}" target="_blank">(view assertion)</a>
			</div>
			<div class="card-body">
				<div class="card-title">Sentence:
				</div>
				<div class="card-text">
					<span id="feedbackSentence" class="evidence_sentence"
						  data-evidence-id="{{ evidence.evidence_id }}"
						  data-subject-span="{{ evidence.subject_entity.span }}"
						  data-subject-text="{{ evidence.subject_entity.covered_text }}"
						  data-subject-curie="{% if evidence.assertion.subject_uniprot %} {{ evidence.assertion.subject_uniprot.uniprot }} {% else %} {{ evidence.assertion.subject_curie }} {% endif %}"
						  data-object-span="{{ evidence.object_entity.span }}"
						  data-object-text="{{ evidence.object_entity.covered_text }}"
						  data-object-curie="{% if evidence.assertion.object_uniprot %} {{ evidence.assertion.object_uniprot.uniprot }} {% else %} {{ evidence.assertion.object_curie }} {% endif %}">
						{{ evidence.sentence }}
					</span>
					<dl class="row">
						<dt class="col-sm-2">Publication:</dt><dd class="col-sm-10"><a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/{{ evidence.document_id }}">{{ evidence.document_id }}<small><i class="bi bi-box-arrow-up-right"></i></small></a></dd>
						<dt class="col-sm-2">Publication Year:</dt><dd class="col-sm-10">{{ evidence.actual_year.year }}</dd>
						<dt class="col-sm-2">Document Zone:</dt><dd class="col-sm-10">{{ evidence.document_zone }}</dd>
						<dt class="col-sm-2">Confidence:</dt><dd class="col-sm-10">{{ evidence.get_score() }}</dd>
						<dt class="col-sm-2">Assertion:</dt><dd class="col-sm-10">
							<span class="badge bg-primary">
								{% if evidence.assertion.subject_uniprot %}
									{{ evidence.assertion.subject_uniprot.uniprot }}
								{% else %}
									{{ evidence.assertion.subject_curie }}
								{% endif %}
							</span>
							<span class="badge bg-secondary">{{ evidence.get_top_predicate().replace('biolink:', '') }}</span>
							<span class="badge bg-info">
								{% if evidence.assertion.object_uniprot %}
									{{ evidence.assertion.object_uniprot.uniprot }}
								{% else %}
									{{ evidence.assertion.object_curie }}
								{% endif %}
							</span>
						</dd>

					</dl>
				</div>
			</div>
		</div>
		<div class="card">
		  <div class="card-header">
			Feedback
		  </div>
		  <div class="card-body">
			<div class="form-check">
			  <input class="form-check-input" type="checkbox" value="" id="overallCheck">
			  <label class="form-check-label" for="overallCheck">
				Assertion does not match sentence
			  </label>
			</div>
			<div class="form-check">
			  <input class="form-check-input" type="checkbox" value="" id="subjectCheck">
			  <label class="form-check-label" for="subjectCheck">
				  Subject <span class="badge bg-primary">
					{% if evidence.assertion.subject_uniprot %}
						{{ evidence.assertion.subject_uniprot.uniprot }}
					{% else %}
						{{ evidence.assertion.subject_curie }}
					{% endif %}
				</span> is incorrect
			  </label>
			</div>
			<div class="form-check">
			  <input class="form-check-input" type="checkbox" value="" id="predicateCheck">
			  <label class="form-check-label" for="predicateCheck">
				  Predicate <span class="badge bg-secondary">{{ evidence.get_top_predicate().replace('biolink:', '') }}</span> is incorrect
			  </label>
			</div>
			<div class="form-check">
			  <input class="form-check-input" type="checkbox" value="" id="objectCheck">
			  <label class="form-check-label" for="objectCheck">
				  Object <span class="badge bg-info">
					{% if evidence.assertion.object_uniprot %}
						{{ evidence.assertion.object_uniprot.uniprot }}
					{% else %}
						{{ evidence.assertion.object_curie }}
					{% endif %}
				</span> is incorrect
			  </label>
			</div>
			<div class="form-check">
			  <input class="form-check-input" type="checkbox" value="" id="overallOK">
			  <label class="form-check-label" for="overallOK">
				Assertion is correct
			  </label>
			</div>
			<div class="mb-3">
				<label for="comments" class="form-label">Additional Comments (optional):</label>
				<input type="text" class="form-control" id="comments">
			</div>
			<button type="button" class="btn btn-outline-primary btn-sm" id="submitButton">Submit Feedback</button>
		  </div>
		</div>
	</main>
	<script>
		$(function() {
			function insertStringAt(originalString, stringToAdd, index) {
				return originalString.slice(0, index) + stringToAdd + originalString.slice(index);
			}

			function spliceStrings(originalString, spliceList) {
				outputString = originalString;
				spliceList.sort((a, b) => a[1] - b[1]);
				var priorInsertLength = 0;
				for(let i = 0; i < spliceList.length; i++) {
					outputString = insertStringAt(outputString, spliceList[i][0], spliceList[i][1] + priorInsertLength);
					priorInsertLength += spliceList[i][0].length;
				}
				return outputString;
			}

			function highlightText(id) {
				sentenceElement = document.getElementById(id);
				sentence = sentenceElement.innerText;
				dataset = sentenceElement.dataset;
				subject_start = parseInt(dataset.subjectSpan.split('|')[0], 10);
				subject_end = parseInt(dataset.subjectSpan.split('|')[1], 10);
				object_start = parseInt(dataset.objectSpan.split('|')[0], 10);
				object_end = parseInt(dataset.objectSpan.split('|')[1], 10);
				let spliceList = [
					['<span class="badge bg-primary" data-bs-toggle="tooltip" title="' + dataset.subjectCurie + '">', subject_start],
					['</span>', subject_end],
					['<span class="badge bg-info" data-bs-toggle="tooltip" title="' + dataset.objectCurie + '">', object_start],
					['</span>', object_end]
				];
				let sentenceHTML = spliceStrings(sentence, spliceList);
				sentenceElement.innerHTML = sentenceHTML;
			}

			function sendFeedback() {
				feedbackObject = {
					'evidence_id' : document.getElementById('feedbackSentence').dataset.evidenceId,
					'overall_correct' : !document.getElementById('overallCheck').checked,
					'subject_correct' : !document.getElementById('subjectCheck').checked,
					'object_correct' : !document.getElementById('objectCheck').checked,
					'predicate_correct' : !document.getElementById('predicateCheck').checked
				}
				commentText = document.getElementById('comments').value
				if(commentText.length > 0) {
					feedbackObject['comments'] = commentText;
				}
				$.ajax({
					url : '/evaluations',
					type : 'POST',
					dataType: 'json',
					contentType: 'application/json;charset=utf-8',
					data : JSON.stringify(feedbackObject),
					success : function() {
						feedbackBtn = $('#submitButton');
						$('#feedbackModal').modal('hide');
						feedbackBtn.prop('disabled', true);
						feedbackBtn.html('Feedback sent')
					},
					error : function(request,error)
					{
						console.log("Request: " + JSON.stringify(request));
					}
				});
			}

			Array.prototype.forEach.call(document.getElementsByClassName('evidence_sentence'), function(element) {
				highlightText(element.id);
			});

			var checkboxes = document.querySelectorAll("input[type=checkbox]");
			checkboxes.forEach(function(checkbox) {
				checkbox.addEventListener('change', function() {
					if (checkbox.checked) {
						if (checkbox.id == 'overallOK') {
							$('input[type=checkbox]').not('#overallOK').prop('checked', false);
						} else {
							$('#overallOK').prop('checked', false);
						}
					}
				});
			});

			document.getElementById('submitButton').addEventListener('click', sendFeedback);
		});
	</script>
</body>
</html>